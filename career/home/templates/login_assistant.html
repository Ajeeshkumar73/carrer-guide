{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" href="{% static 'images/favicon-1.png' %}" sizes="256x256" type="image/png">

    <title>LearnLoop-AI career Assistant</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            primary: 'black',
            "background-light": "#ffffff",
            "background-dark": "#343541",
            "sidebar-light": "#c0c0c3ff",
            "sidebar-dark": "#202123",
            "text-light": "#202123",
            "text-dark": "#ececf1",
            "border-light": "#e5e5e5",
            "border-dark": "#4d4d4f",
            "input-light": "#ffffff",
            "input-dark": "#40414f",
          },
          fontFamily: { sans: ['Roboto', 'sans-serif'] },
          borderRadius: { DEFAULT: '0.5rem' },
        },
      },
    };
  </script>
  <style>
    .material-icons { font-size: 24px; }
    /* simple custom bubble max width and responsive layout adjustments */
    .chat-wrapper { width:100%; max-width:900px; margin:0 auto; }
  .chat-row { display:flex; margin:6px 0; }
  .chat-row.ai { justify-content:flex-start; }    /* left */
  .chat-row.user { justify-content:flex-end; }    /* right */
  .bubble {
    padding:10px 14px;
    border-radius:12px;
    max-width:80%;
    word-wrap:break-word;
    box-shadow: 0 1px 0 rgba(0,0,0,0.04) inset;
  }
  .bubble.ai {
    background:#2563eb; /* blue */
    color:#fff;
    margin-left: 6px;   /* small gap from left edge */
  }
  .bubble.user {
    background:#2563eb; /* green */
    color:#fff;
    margin-right: 6px;  /* small gap from right edge */
  }

  /* When screen is narrow, reduce max width */
  @media (max-width:640px) {
    .bubble { max-width:92%; padding:10px; }
    .chat-wrapper { padding: 0 12px; }
  }
  </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-sans">



  <div class="flex h-screen">
    <!-- Sidebar -->
    <aside id="sidebar"
           class="w-64 bg-sidebar-light dark:bg-sidebar-dark flex flex-col text-text-light dark:text-text-dark
                  transform -translate-x-full md:translate-x-0 transition-transform duration-300
                  fixed md:static inset-y-0 left-0 z-40 md:z-auto">
      <div class="p-4 border-b border-border-light dark:border-border-dark flex items-center justify-between">
        <h1 class="text-xl font-bold">LearnLoop</h1>
        <!-- small-screen close button -->
        <button id="sidebar-close-btn" class="p-1 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700 md:hidden">
          <span class="material-icons">close</span>
        </button>
      </div>
      <div class="flex-grow p-4 space-y-2">
        <a  id="new-chat-btn" class="flex items-center justify-between p-3 rounded-md bg-primary text-white" href="#">
          <span>New Chat</span>
          <span class="material-icons">edit</span>
        </a>
        <a class="flex items-center p-3 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700" href="{% url 'predict_page' %}">
          <span>Find Career Domain</span>
        </a>
      </div>
      <div class="p-4 border-t border-border-light dark:border-border-dark">
        <a class="flex items-center p-3 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700" href="{% url 'logout' %}">
          <span class="material-icons mr-2">logout</span>
          <span>Logout</span>
        </a>
      </div>
    </aside>

    <!-- Overlay for small screens when sidebar is open -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black/40 opacity-0 pointer-events-none transition-opacity duration-300 z-30 md:hidden"></div>

    <!-- Main area -->
    <main class="flex-1 flex flex-col">
      <header class="flex items-center justify-end p-4 border-b border-border-light dark:border-border-dark" style="height: 61px;">
        <div class="flex items-center space-x-4">
          <!-- Header menu button (three-bar) -->
          <button id="header-menu-btn" class="p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700 md:hidden">
            <span class="material-icons">menu</span>
          </button>

          <!--<button id="dark-toggle" class="p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700" title="Toggle dark mode">
            <span id="dark-icon" class="material-icons">dark_mode</span>
          </button>-->

        <div style="display: flex; align-items: center; gap: 10px;">
  <!-- SVG Profile Icon -->
 <div class="flex items-center justify-center w-8 h-8 bg-black rounded-full text-white shadow-md">
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
    <path d="M12 12c2.7 0 4.9-2.2 4.9-4.9S14.7 2.2 12 2.2 7.1 4.4 7.1 7.1 9.3 12 12 12zm0 2.4c-3.2 0-9.6 1.6-9.6 4.8V22h19.2v-2.8c0-3.2-6.4-4.8-9.6-4.8z"/>
  </svg>
</div>

  <!-- User email -->
  <h3>{{ email }}</h3>
</div>

        </div>
      </header>

      <header class="p-6  bg-input-light dark:bg-input-dark">
        <div class="flex justify-between items-center text-sm pt-2">
          <div class="text-gray-600">
            <span id="login-status" class="font-semibold text-gray-800">Offline Mode</span>
            <span id="service-status" class="text-xs text-gray-400 ml-2"></span>
          </div>
          <div class="flex items-center space-x-3">
            <div class="flex items-center space-x-2 bg-gray-100 p-1 rounded-lg text-sm shadow-inner">
              <button id="lang-en" onclick="setLanguage('en')" class="px-3 py-1 rounded-md bg-primary text-white hover:bg-blue-600">EN</button>
              <button id="lang-ml" onclick="setLanguage('ml')" class="px-3 py-1 rounded-md hover:bg-blue-600 text-gray-700">ML</button>
            </div>
          </div>
        </div>
      </header>
      <div class="text-center">
      <h2 class="text-3xl sm:text-4xl font-bold text-gray-800 dark:text-gray-100 mb-2">
        LearnLoop
      </h2>
      <p class="text-lg sm:text-xl text-gray-600 dark:text-gray-300">
        Speak with your personal AI career assistant.
      </p>
    </div>

      <!-- Chat area -->
      <main id="chat-history" class="flex-grow overflow-y-auto p-6 space-y-4 bg-input-light dark:bg-input-dark">
        <!-- initial bubble inside centered box (will be replaced by renderChatHistory contents) -->
        <div class="flex justify-center">
          <div class="bg-blue-600 text-white p-4 rounded-xl max-w-2xl">
            Hello! I'm your AI Career Assistant. How can I assist you with your career journey today?
          </div>
        </div>
      </main>

       <footer class="p-6 border-gray-200 flex items-end bg-input-light dark:bg-input-dark">
  <button id="mic-button" onclick="toggleVoiceInput()" 
          class="p-6 rounded-full text-white transition-colors duration-300 flex items-center justify-center"
          style="background:black; margin-left:600px; margin-bottom:10px; height:60px; width:60px;">
    <span class="material-icons text-4xl">mic</span>
  </button>
  
</footer>

      <div id="status-indicator" class="text-center text-sm p-2 text-gray-500 bg-input-light dark:bg-input-dark hidden">
        <div id="loading-spinner" class="inline-block animate-spin w-4 h-4 border-b-2 border-blue-400 mr-2 hidden"></div>
        <span id="status-message"></span>
      </div>
    </main>
  </div>

<script>
/* Full voice script with language toggle:
   - EN: listen English, respond English (browser TTS)
   - ML: listen Malayalam, respond Malayalam (prefer proxy/model TTS)
   - Replace previous script block with this.
*/

let uiLanguage = 'en'; // 'en' or 'ml' — chosen by UI (EN/ML buttons)
let chatHistory = [];
let activeAudio = null;
let recognition = null;
let isRecording = false;
let isProcessing = false;

const apiKey = "AIzaSyCsHff1rzdDIGmB4dYyxxqEqL_8Sg4VOyU"; // move server-side in production
const GEMINI_TEXT_MODEL = "gemini-2.5-flash-preview-05-20";
const GEMINI_TTS_MODEL = "gemini-2.5-flash-preview-tts";

const chatHistoryEl = document.getElementById('chat-history');
const micButton = document.getElementById('mic-button');
const statusIndicator = document.getElementById('status-indicator');
const statusMessage = document.getElementById('status-message');
const serviceStatusEl = document.getElementById('service-status');
const langEnBtn = document.getElementById('lang-en');
const langMlBtn = document.getElementById('lang-ml');

/* ---------- UI helpers ---------- */
function setStatus(msg, showSpinner = false) {
  if (!statusIndicator) return;
  statusIndicator.classList.remove('hidden');
  statusMessage.textContent = msg;
  const spinner = document.getElementById('loading-spinner');
  if (spinner) spinner.classList.toggle('hidden', !showSpinner);
}
function hideStatus() { if (statusIndicator) statusIndicator.classList.add('hidden'); }
function setServiceStatus(text, isError=false) { if (!serviceStatusEl) return; serviceStatusEl.textContent = text; serviceStatusEl.style.color = isError ? '#b91c1c' : '#374151'; }

/* ---------- Career + Education filter (unchanged) ---------- */
function isCareerRelated(text){
  if(!text||typeof text!=="string") return false;
  const t = text.toLowerCase();
  const nonCareerSignals = ["weather","joke","sexual","porn","song","lyrics","sports score","play song","how to make","how to cook","recipe","bank account","hack","illegal"];
  if (nonCareerSignals.some(s => t.includes(s))) return false;
  const careerEduKeywords = [
    "career","job","resume","cv","cover letter","interview","skills","internship","employment","salary",
    "promotion","portfolio","linkedin","freelance","work experience","hiring","recruiter","role",
    "education","study","studying","school","sslc","10th","10th grade","secondary","high school","higher secondary","+2",
    "intermediate","college","university","degree","diploma","engineering","medical","mbbs","doctor","dr","btech",
    "mca","mphil","phd","admission","entrance","how to become","what to study","which course","stream","science","commerce","arts",
    "next","after sslc","after 10th","after 12th","what next","class 10","class 12"
  ];
  if (careerEduKeywords.some(k => t.includes(k))) return true;
  if (t.split(/\s+/).length <= 4) return true;
  return false;
}

/* ---------- Normalize short questions ---------- */
function normalizeShortQuestion(q){
  if(!q || typeof q !== 'string') return q;
  return q
    .replace(/\bdr\b/ig, 'doctor')
    .replace(/\bsslc\b/ig, '10th grade')
    .replace(/\bhow to become\b/ig, 'how to become')
    .replace(/\bwhat next\b/ig, 'what to study next')
    .replace(/\bafter sslc\b/ig, 'after 10th grade')
    .replace(/\bafter 10th\b/ig, 'after 10th grade')
    .replace(/\bafter 12th\b/ig, 'after 12th grade')
    .replace(/\bpls\b/ig, 'please')
    .trim();
}

/* ---------- Render chat ---------- */
function renderChatHistory(history){
  if(!chatHistoryEl) return;
  chatHistoryEl.innerHTML = '';
  const wrapper = document.createElement('div');
  wrapper.className = 'chat-wrapper';
  history.forEach(msg=>{
    const row = document.createElement('div');
    row.className = 'chat-row ' + (msg.role === 'user' ? 'user' : 'ai');
    const bubble = document.createElement('div');
    bubble.className = 'bubble ' + (msg.role === 'user' ? 'user' : 'ai');
    bubble.textContent = msg.text;
    row.appendChild(bubble);
    wrapper.appendChild(row);
  });
  chatHistoryEl.appendChild(wrapper);
  const spacer = document.createElement('div'); spacer.style.height = '20px';
  chatHistoryEl.appendChild(spacer);
  chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
}

/* ---------- Binary helpers ---------- */
function base64ToUint8Array(base64){ const binary = atob(base64.replace(/\s/g,'')); const bytes = new Uint8Array(binary.length); for (let i=0;i<binary.length;i++) bytes[i]=binary.charCodeAt(i); return bytes; }
function pcm16ToWavBlob(pcm16Array, sampleRate = 24000){ const buffer = new ArrayBuffer(44 + pcm16Array.length * 2); const view = new DataView(buffer); function writeString(view, offset, str){ for(let i=0;i<str.length;i++) view.setUint8(offset+i,str.charCodeAt(i)); } writeString(view,0,'RIFF'); view.setUint32(4,36+pcm16Array.length*2,true); writeString(view,8,'WAVE'); writeString(view,12,'fmt '); view.setUint32(16,16,true); view.setUint16(20,1,true); view.setUint16(22,1,true); view.setUint32(24,sampleRate,true); view.setUint32(28,sampleRate*2,true); view.setUint16(32,2,true); view.setUint16(34,16,true); writeString(view,36,'data'); view.setUint32(40,pcm16Array.length*2,true); let offset=44; for(let i=0;i<pcm16Array.length;i++,offset+=2) view.setInt16(offset,pcm16Array[i],true); return new Blob([view],{type:'audio/wav'}); }

/* ---------- Voice name ---------- */
function getTtsVoiceName(lang){ return lang === 'ml' ? "Rasalgethi" : "Kore"; }

/* ---------- Proxy TTS (recommended) ---------- */
async function speakViaProxy(text, lang){
  setStatus(lang==='ml' ? 'സംസാരിക്കുന്നു...' : 'Speaking...', true);
  try {
    const resp = await fetch('/api/tts', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text, lang })
    });
    if (!resp.ok) {
      const txt = await resp.text().catch(()=>"(no body)");
      console.warn('Proxy TTS non-OK', resp.status, txt);
      hideStatus();
      return false;
    }
    const data = await resp.json();
    const b64 = data?.audioContent || data?.audio || null;
    if (!b64) { console.warn('Proxy returned no audioContent', data); hideStatus(); return false; }
    const bytes = base64ToUint8Array(b64);
    const wavBlob = pcm16ToWavBlob(new Int16Array(bytes.buffer));
    const urlBlob = URL.createObjectURL(wavBlob);
    if (activeAudio) { activeAudio.pause(); activeAudio = null; }
    activeAudio = new Audio(urlBlob);
    activeAudio.onended = hideStatus;
    await activeAudio.play().catch(e => { console.warn('Proxy audio play failed', e); hideStatus(); });
    return true;
  } catch (err) {
    console.error('speakViaProxy error', err);
    hideStatus();
    return false;
  }
}

/* ---------- Model TTS (may be CORS-limited) ---------- */
async function speakWithModelTTS(text, lang){
  setStatus(lang==='ml' ? 'സംസാരിക്കുന്നു...' : 'Speaking...', true);
  try {
    const url = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_TTS_MODEL}:generateContent?key=${apiKey}`;
    const payload = {
      contents:[{parts:[{text}]}],
      generationConfig:{ responseModalities:["AUDIO"], speechConfig:{ voiceConfig:{ prebuiltVoiceConfig:{ voiceName: getTtsVoiceName(lang) } } } }
    };
    const resp = await fetch(url, { method:'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    if (!resp.ok) { const txt = await resp.text().catch(()=>"(no body)"); throw new Error('generateContent failed: '+txt); }
    const data = await resp.json();
    const part = data?.candidates?.[0]?.content?.parts?.[0];
    const audioBase64 = part?.inlineData?.audio?.content || part?.inlineData?.data || null;
    const mime = part?.inlineData?.mimeType || '';
    if (audioBase64) {
      const bytes = base64ToUint8Array(audioBase64);
      if (mime.toLowerCase().includes('l16') || mime.toLowerCase().includes('pcm16')) {
        const wavBlob = pcm16ToWavBlob(new Int16Array(bytes.buffer));
        const urlBlob = URL.createObjectURL(wavBlob);
        if (activeAudio) { activeAudio.pause(); activeAudio = null; }
        activeAudio = new Audio(urlBlob);
        activeAudio.onended = hideStatus;
        await activeAudio.play().catch(e=>{ console.warn('model audio play failed', e); hideStatus(); });
        return true;
      } else {
        const blob = new Blob([bytes.buffer], { type: mime || 'audio/mpeg' });
        const urlBlob = URL.createObjectURL(blob);
        if (activeAudio) { activeAudio.pause(); activeAudio = null; }
        activeAudio = new Audio(urlBlob);
        activeAudio.onended = hideStatus;
        await activeAudio.play().catch(e=>{ console.warn('model audio play failed', e); hideStatus(); });
        return true;
      }
    }
  } catch (err) {
    console.warn('Model TTS failed or blocked:', err);
  }

  // generateTTS fallback
  try {
    const altUrl = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_TTS_MODEL}:generateTTS?key=${apiKey}`;
    const altPayload = { input: text, voice: getTtsVoiceName(lang), audioConfig: { audioEncoding: "LINEAR16" } };
    const resp2 = await fetch(altUrl, { method:'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(altPayload) });
    if (!resp2.ok) { const txt = await resp2.text().catch(()=>"(no body)"); throw new Error('generateTTS failed: '+txt); }
    const d2 = await resp2.json();
    const b64 = d2?.audioContent || d2?.audio?.content || null;
    if (b64) {
      const bytes = base64ToUint8Array(b64);
      const wavBlob = pcm16ToWavBlob(new Int16Array(bytes.buffer));
      const urlBlob = URL.createObjectURL(wavBlob);
      if (activeAudio) { activeAudio.pause(); activeAudio = null; }
      activeAudio = new Audio(urlBlob);
      activeAudio.onended = hideStatus;
      await activeAudio.play().catch(e=>{ console.warn('model generateTTS play failed', e); hideStatus(); });
      return true;
    }
  } catch (err2) {
    console.warn('Model generateTTS fallback failed:', err2);
  }

  return false;
}

/* ---------- Browser TTS (speechSynthesis) ---------- */
function speakWithWebSpeech(text, lang){
  if(!('speechSynthesis' in window)) return;
  const synth = window.speechSynthesis;
  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = (lang === 'ml') ? 'ml-IN' : 'en-US';
  synth.speak(utter);
  setStatus(lang==='ml' ? 'സംസാരിക്കുന്നു...' : 'Speaking...');
  utter.onend = ()=> hideStatus();
}

/* ---------- API helper (retry) ---------- */
async function makeApiCallWithRetry(apiUrl,payload,retries=3,baseDelay=800){
  for (let i=0;i<retries;i++){
    try{
      const resp = await fetch(apiUrl, { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify(payload) });
      if (!resp.ok) { const body = await resp.text().catch(()=>"(no body)"); throw new Error(`API error ${resp.status}: ${body}`); }
      return await resp.json();
    } catch(err) {
      console.error('API attempt failed', err);
      if (i === retries - 1) throw err;
      await new Promise(r => setTimeout(r, baseDelay * Math.pow(2, i)));
    }
  }
}

/* ---------- Text generation: system prompt uses uiLanguage ---------- */
async function generateText(prompt){
  if (!isCareerRelated(prompt)) {
    return uiLanguage === 'ml'
      ? "ക്ഷമിക്കൂ — ഞാൻ കരിയർ/വിദ്യാഭ്യാസവുമായി ബന്ധപ്പെട്ട ചോദ്യങ്ങൾ മാത്രം സഹായിക്കും."
      : "Sorry — I only assist with career and education related questions.";
  }

  // instruct model to reply in selected language
  const langInstruction = (uiLanguage === 'ml')
    ? "Always respond in Malayalam (only Malayalam)."
    : "Always respond in English (only English).";

  const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_TEXT_MODEL}:generateContent?key=${apiKey}`;
  const systemPrompt = `You are a helpful assistant for careers and education. ${langInstruction} Provide concise, actionable guidance for careers, education pathways, entrance exams, and next steps.`;
  const payload = { contents:[{parts:[{text:prompt}]}], systemInstruction: { parts: [{ text: systemPrompt }] } };

  try {
    const result = await makeApiCallWithRetry(apiUrl, payload);
    const out = result?.candidates?.[0]?.content?.parts?.[0]?.text;
    if (!out) throw new Error('No text returned from model');
    setServiceStatus("Service: OK");
    return out;
  } catch(err){
    console.error('Text gen failed', err);
    setServiceStatus("Service: Unavailable", true);
    throw err;
  }
}

/* ---------- Speech recognition: language follows uiLanguage ---------- */
function createSpeechRecognition(){
  if(!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)){
    if(micButton) { micButton.disabled = true; micButton.title = "Voice input not supported."; }
    return null;
  }
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  const rec = new SR();
  rec.continuous = false;
  rec.interimResults = false;
  rec.lang = (uiLanguage === 'ml') ? 'ml-IN' : 'en-US';

  rec.onstart = () => {
    isRecording = true;
    if (micButton) micButton.style.background = '#dc2626';
    setStatus(uiLanguage === 'ml' ? 'കേൾക്കുന്നു...' : 'Listening...');
  };

  rec.onresult = (ev) => {
    const transcript = ev.results[0][0].transcript;
    setStatus(uiLanguage === 'ml' ? 'ശബ്ദം തിരിച്ചറിഞ്ഞു...' : 'Speech recognized...');
    setTimeout(() => sendMessage(transcript), 250);
  };

  rec.onerror = (e) => {
    console.error('Speech recognition error', e);
    resetVoiceInputUI();
  };

  rec.onend = resetVoiceInputUI;
  return rec;
}
function resetVoiceInputUI(){ isRecording = false; if (micButton) micButton.style.background = 'black'; hideStatus(); }
function toggleVoiceInput(){
  if (activeAudio) { try { activeAudio.pause(); } catch(e){} activeAudio = null; }
  if ('speechSynthesis' in window) window.speechSynthesis.cancel();
  if (isRecording && recognition) { recognition.stop(); return; }
  if (!recognition) recognition = createSpeechRecognition();
  recognition?.start();
}

/* ---------- sendMessage: voice-driven (uses uiLanguage) ---------- */
async function sendMessage(textFromVoice){
  if (isProcessing) return;
  if (!textFromVoice || typeof textFromVoice !== 'string') return;

  if (activeAudio) { try { activeAudio.pause(); } catch(e) {} activeAudio = null; }
  if ('speechSynthesis' in window) window.speechSynthesis.cancel();

  isProcessing = true;
  if (micButton) micButton.disabled = true;

  const normalized = normalizeShortQuestion(textFromVoice);

  chatHistory.push({ text: textFromVoice, role: 'user' });
  renderChatHistory(chatHistory);

  setStatus(uiLanguage === 'ml' ? 'ഉത്തരം തയ്യാറാക്കുന്നു...' : 'Generating response...', true);

  try {
    const aiText = await generateText(normalized);
    chatHistory.push({ text: aiText, role: 'ai' });
    renderChatHistory(chatHistory);

    if (uiLanguage === 'ml') {
      // Malayalam: prefer proxy/model TTS
      const okProxy = await speakViaProxy(aiText, 'ml').catch(()=>false);
      if (!okProxy) {
        const okModel = await speakWithModelTTS(aiText, 'ml').catch(()=>false);
        if (!okModel) speakWithWebSpeech(aiText, 'ml');
      }
    } else {
      // English: prefer browser TTS for simplicity (synth voices are usually available)
      speakWithWebSpeech(aiText, 'en');
    }

  } catch (err) {
    console.error('Chat flow error', err);
    const failMsg = uiLanguage === 'ml' ? "സഹായിക്കാൻ കഴിഞ്ഞില്ല. ദയവായി പിന്നീട് വീണ്ടും ശ്രമിക്കുക." : "Could not generate a response. Try again later.";
    chatHistory.push({ text: failMsg, role: 'ai' });
    renderChatHistory(chatHistory);
  } finally {
    isProcessing = false;
    if (micButton) micButton.disabled = false;
    if (!activeAudio) hideStatus();
  }
}

/* ---------- UI language switch (public) ---------- */
function setLanguage(lang){
  if (lang !== 'en' && lang !== 'ml') return;
  uiLanguage = lang;

  // update buttons styling if present
  if (langEnBtn) { langEnBtn.classList.toggle('bg-primary', lang==='en'); langEnBtn.classList.toggle('text-white', lang==='en'); }
  if (langMlBtn) { langMlBtn.classList.toggle('bg-primary', lang==='ml'); langMlBtn.classList.toggle('text-white', lang==='ml'); }

  // recreate recognition to apply new language
  if (recognition && typeof recognition.stop === 'function') {
    try { recognition.stop(); } catch(e){}
    recognition = null;
  }
  recognition = createSpeechRecognition();

  // optional: change initial greeting to match language
  const greeting = (uiLanguage === 'ml')
    ? "ഹലോ! ഞാൻ നിങ്ങളുടെ കരിയർ & വിദ്യാഭ്യാസ ഗൈഡാണ്. പഠനത്തിലും കരിയറിലും എങ്ങനെ സഹായിക്കാമെന്ന് പറഞ്‌ഞു?"
    : "Hello! I'm your AI Career & Education Guide. How can I help with your studies or career?";
  // replace last AI greeting or push new
  chatHistory = [{ text: greeting, role: 'ai' }];
  renderChatHistory(chatHistory);
}

/* ---------- Init ---------- */
document.addEventListener('DOMContentLoaded', () => {
  // wire UI buttons (if present)
  if (langEnBtn) langEnBtn.addEventListener('click', () => setLanguage('en'));
  if (langMlBtn) langMlBtn.addEventListener('click', () => setLanguage('ml'));

  // start in English by default (or setLanguage('ml') if you prefer)
  setLanguage(uiLanguage);

  // prepare recognition but don't auto-start
  recognition = createSpeechRecognition();
});


//new chat
  document.getElementById('new-chat-btn').addEventListener('click', (e) => {
  e.preventDefault();  // prevent default link behavior
  chatHistory = [];     // clear chat history
  renderChatHistory(chatHistory);  // re-render (empty)
  
  // Optional: add initial AI greeting again
  const initialMsg = currentLanguage === 'ml' 
    ? "ഹലോ! ഞാൻ നിങ്ങളുടെ കരിയർ ഗൈഡ് ആണു. നിങ്ങൾക്ക് എങ്ങനെ സഹായിക്കാമെന്ന് പറയൂ?" 
    : "Hello! I'm your AI Career Guide. How can I assist you with your professional journey today?";
    
  chatHistory.push({text: initialMsg, role: 'ai'});
  renderChatHistory(chatHistory);
});

/* ---------- Stop all audio & recognition ---------- */
function stopAllAudio() {
  try {
    if (activeAudio) { activeAudio.pause(); activeAudio = null; }
    if ('speechSynthesis' in window) window.speechSynthesis.cancel();
    if (recognition && isRecording) recognition.stop();
    isRecording = false;
    if (micButton) micButton.style.background = 'black';
    hideStatus();
  } catch (err) { console.warn('stopAllAudio error', err); }
}

/* ---------- toggle mic ---------- */
function toggleVoiceInput(){
  stopAllAudio();
  if (!isRecording) {
    if (!recognition) recognition = createSpeechRecognition();
    recognition?.start();
  }
}

/* Stop speech when chat area is clicked */
if (chatHistoryEl) {
  chatHistoryEl.addEventListener('click', stopAllAudio);
}
</script>
</body>
</html>
